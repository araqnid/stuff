#!/bin/sh

set -e

cd "$(dirname $0)"
if [ -f .build_number ]; then
    BUILD_NUMBER=$(expr $(cat .build_number) + 1)
else
    BUILD_NUMBER=1
fi
echo $BUILD_NUMBER > .build_number
export BUILD_NUMBER

gradle clean build

tmpdir=$(mktemp -d)
trap 'rm -rf "$tmpdir"' EXIT

ln -sfn $PWD/build/libs/stuff-0.0.$BUILD_NUMBER.jar $tmpdir/stuff-0.0.$BUILD_NUMBER.jar
ln -sfn $PWD/run_service $tmpdir/stuff-run_service-$BUILD_NUMBER.sh

tar --dereference -C $tmpdir -c -f - . | ssh harvestman "tar -x -f - && ln -sfvn stuff-0.0.$BUILD_NUMBER.jar stuff-latest.jar && cp stuff-run_service-$BUILD_NUMBER.sh stuff_service/run && svc -t stuff_service"
